<rd-header>
  <rd-header-title title="Детали узла">
    <a data-toggle="tooltip" title="Обновление" ui-sref="node({id: node.Id})" ui-sref-opts="{reload: true}">
      <i class="fa fa-refresh" aria-hidden="true"></i>
    </a>
  </rd-header-title>
  <rd-header-content>
    <a ui-sref="swarm">Swarm узлы</a> > <a ui-sref="node({id: node.Id})">{{ node.Hostname }}</a>
  </rd-header-content>
</rd-header>

<div class="row" ng-if="!node">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <div ng-if="loading">
      <i class="fa fa-cog fa-spin"></i> Загрузка...
    </div>

    <rd-widget ng-if="!loading">
      <rd-widget-header icon="fa-object-group" title="Узел не существует"></rd-widget-header>
      <rd-widget-body>
        <p>Похоже, что узел, который вы хотите проверить, не существует.</p>
      </rd-widget-body>
    </rd-widget>
  </div>
</div>

<div class="row" ng-if="node">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <rd-widget>
      <rd-widget-header icon="fa-object-group" title="Спецификация узла"></rd-widget-header>
      <rd-widget-body classes="no-padding">
        <table class="table">
          <tbody>
            <tr>
              <td>Имя</td>
              <td>
                <input type="text" class="input-sm" ng-model="node.Name" placeholder="e.g. my-manager" ng-change="updateNodeAttribute(node, 'Name')">
              </td>
            </tr>
            <tr>
              <td>Имя хоста</td>
              <td>{{ node.Hostname }}</td>
            </tr>
            <tr>
              <td>Роль</td>
              <td>{{ node.Role }}</td>
            </tr>
            <tr>
              <td>Доступность</td>
              <td>
                <div class="input-group input-group-sm">
                  <select name="nodeAvailability" class="selectpicker form-control" ng-model="node.Availability" ng-change="updateNodeAttribute(node, 'Availability')">
                    <option value="active">Активный</option>
                    <option value="pause">Пауза</option>
                    <option value="drain">Утечка</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr>
              <td>Статус</td>
              <td><span class="label label-{{ node.Status|nodestatusbadge }}">{{ node.Status }}</span></td>
            </tr>
          </tbody>
        </table>
      </rd-widget-body>
      <rd-widget-footer>
        <p class="small text-muted">
          Просмотр документации узла Docker Swarm mode <a href="https://docs.docker.com/engine/swarm/manage-nodes/" target="self">здесь</a>.
        </p>
        <div class="btn-toolbar" role="toolbar">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" ng-disabled="!hasChanges(node, ['Name', 'Availability'])" ng-click="updateNode(node)">Применить изменения</button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
              <li><a ng-click="cancelChanges(node)">Сбросить изменения</a></li>
            </ul>
          </div>
        </div>
      </rd-widget-footer>
    </rd-widget>
  </div>
</div>

<div class="row" ng-if="node && node.Role === 'manager'">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <rd-widget>
      <rd-widget-header icon="fa-object-group" title="Статус менеджера"></rd-widget-header>
      <rd-widget-body classes="no-padding">
        <table class="table">
          <tbody>
            <tr>
              <td>Лидер</td>
              <td>
                <span ng-if="node.Leader"><i class="fa fa-check green-icon" aria-hidden="true"></i> Да</span>
                <span ng-if="!node.Leader"><i class="fa fa-times red-icon" aria-hidden="true"></i> Нет</span>
              </td>
            </tr>
            <tr>
              <td>Достижимость</td>
              <td>{{ node.Reachability }}</td>
            </tr>
            <tr>
              <td>Адрес менеджера</td>
              <td>{{ node.ManagerAddr }}</td>
            </tr>
          </tbody>
        </table>
      </rd-widget-body>
    </rd-widget>
  </div>
</div>

<div class="row" ng-if="node">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <rd-widget>
      <rd-widget-header icon="fa-object-group" title="Описания узла"></rd-widget-header>
      <rd-widget-body classes="no-padding">
        <table class="table">
          <tbody>
            <tr>
              <td>CPU</td>
              <td>{{ node.CPUs / 1000000000 }}</td>
            </tr>
            <tr>
              <td>Память</td>
              <td>{{ node.Memory|humansize: 2 }}</td>
            </tr>
            <tr>
              <td>Платформа</td>
              <td>{{ node.PlatformOS }} {{ node.PlatformArchitecture }} </td>
            </tr>
            <tr>
              <td>Версия системы Docker</td>
              <td>{{ node.EngineVersion }}</td>
            </tr>
          </tbody>
        </table>
      </rd-widget-body>
    </rd-widget>
  </div>
</div>

<div class="row" ng-if="node">
  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <rd-widget>
      <rd-widget-header icon="fa-tasks" title="Метки узла">
        <div class="nopadding">
          <a class="btn btn-default btn-sm pull-right" ng-click="addLabel(node)">
            <i class="fa fa-plus-circle" aria-hidden="true"></i> метка
          </a>
        </div>
      </rd-widget-header>
      <rd-widget-body ng-if="!node.Labels || node.Labels.length === 0">
        <p>Для этого узла нет меток.</p>
      </rd-widget-body>
      <rd-widget-body classes="no-padding" ng-if="node.Labels && node.Labels.length > 0">
        <table class="table">
          <thead>
            <tr>
              <th>Метка</th>
              <th>Значение</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="label in node.Labels">
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-addon fit-text-size">имя</span>
                  <input type="text" class="form-control" ng-model="label.key" placeholder="e.g. com.example.foo" ng-change="updateLabel(node, label)">
                </div>
              </td>
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-addon fit-text-size">значение</span>
                  <input type="text" class="form-control" ng-model="label.value" placeholder="e.g. bar" ng-change="updateLabel(node, label)">
                  <span class="input-group-btn">
                    <button class="btn btn-sm btn-danger" type="button" ng-click="removeLabel(node, $index)">
                      <i class="fa fa-trash" aria-hidden="true"></i>
                    </button>
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </rd-widget-body>
      <rd-widget-footer>
        <div class="btn-toolbar" role="toolbar">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary btn-sm" ng-disabled="!hasChanges(node, ['Labels'])" ng-click="updateNode(node)">Применить изменения</button>
            <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
              <li><a ng-click="cancelChanges(node)">Сбросить изменения</a></li>
            </ul>
          </div>
        </div>
      </rd-widget-footer>
    </rd-widget>
  </div>
</div>

<div class="row" ng-if="node && tasks.length > 0">
  <div class="col-lg-12 col-md-12 col-xs-12">
    <rd-widget>
      <rd-widget-header icon="fa-tasks" title="Связанные задачи">
        <div class="pull-right">
          Количество элементов на странице:
          <select ng-model="state.pagination_count" ng-change="changePaginationCount()">
            <option value="0">Все</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </rd-widget-header>
      <rd-widget-body classes="no-padding">
        <table class="table">
          <thead>
            <tr>
              <th>Id</th>
              <th>
                <a ui-sref="node" ng-click="order('Status')">
                  Статус
                  <span ng-show="sortType == 'Status' && !sortReverse" class="glyphicon glyphicon-chevron-down"></span>
                  <span ng-show="sortType == 'Status' && sortReverse" class="glyphicon glyphicon-chevron-up"></span>
                </a>
              </th>
              <th>
                <a ui-sref="node" ng-click="order('Slot')">
                  Слот
                  <span ng-show="sortType == 'Slot' && !sortReverse" class="glyphicon glyphicon-chevron-down"></span>
                  <span ng-show="sortType == 'Slot' && sortReverse" class="glyphicon glyphicon-chevron-up"></span>
                </a>
              </th>
              <th>
                <a ui-sref="node" ng-click="order('Spec.ContainerSpec.Image')">
                  Образ
                  <span ng-show="sortType == 'Spec.ContainerSpec.Image' && !sortReverse" class="glyphicon glyphicon-chevron-down"></span>
                  <span ng-show="sortType == 'Spec.ContainerSpec.Image' && sortReverse" class="glyphicon glyphicon-chevron-up"></span>
                </a>
              </th>
              <th>
                <a ui-sref="node" ng-click="order('Updated')">
                  Последнее обновление
                  <span ng-show="sortType == 'Updated' && !sortReverse" class="glyphicon glyphicon-chevron-down"></span>
                  <span ng-show="sortType == 'Updated' && sortReverse" class="glyphicon glyphicon-chevron-up"></span>
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr dir-paginate="task in (filteredTasks = ( tasks | orderBy:sortType:sortReverse | itemsPerPage: state.pagination_count))">
              <td><a ui-sref="task({ id: task.Id })">{{ task.Id }}</a></td>
              <td><span class="label label-{{ task.Status.State|taskstatusbadge }}">{{ task.Status.State }}</span></td>
              <td>{{ task.Slot ? task.Slot : '-' }}</td>
              <td>{{ task.Spec.ContainerSpec.Image | hideshasum }}</td>
              <td>{{ task.Updated | getisodate }}</td>
            </tr>
          </tbody>
        </table>
        <div ng-if="tasks" class="pagination-controls">
          <dir-pagination-controls></dir-pagination-controls>
        </div>
      </rd-widget-body>
    </rd-widget>
  </div>
</div>
